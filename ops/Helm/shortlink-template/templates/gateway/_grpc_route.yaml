{{/* vim: set filetype=mustache: */}}

{{/*
`shortlink-common.grpc_route` Helm template

GRPCRoute for Gateway API traffic routing.

When used with Argo Rollouts Canary, creates GRPCRoute with two backendRefs:
- stable service (weight 100)
- canary/preview service (weight 0)

Argo Rollouts will manage the weights during canary deployment.
Docs: https://rollouts-plugin-trafficrouter-gatewayapi.readthedocs.io/

Behavior:
- Generates a GRPCRoute when `grpcRoute.enabled` is true.
- By default attaches to Gateway:
    name: internal-gateway
    namespace: istio-system
- By default routes all gRPC methods to the first `service.ports[]` entry with `public: true`.
- Backend service name defaults to `helpers.fullname`.

Override points in values:
- grpcRoute.hostnames
- grpcRoute.gatewayName / grpcRoute.gatewayNamespace
- grpcRoute.parentRefs (full override)
- grpcRoute.method (single gRPC method match)
- grpcRoute.methods (list of gRPC method matches for multiple method matches)
- grpcRoute.port
- grpcRoute.rules (full override of rules block)
- grpcRoute.backendRefs (full override of backendRefs)
*/}}

{{- define "shortlink-common.grpc_route" }}
{{- if .Values.grpcRoute.enabled }}
{{- $ := . }}

{{/* Compute default backend port: first public service port */}}
{{- $backend := dict }}
{{- range .Values.service.ports }}
  {{- if and .public (not (hasKey $backend "port")) }}
    {{- $_ := set $backend "port" .port }}
  {{- end }}
{{- end }}
{{- $defaultBackendPort := (index $backend "port" | default 50051) }}

{{- $serviceName := (include "helpers.fullname" .) }}
{{- $servicePort := (.Values.grpcRoute.port | default $defaultBackendPort) }}

{{- /* Check if using Rollout with Canary strategy */ -}}
{{- $isCanary := and (eq (.Values.deploy.type | default "Deployment") "Rollout") (eq (.Values.deploy.strategy.type | default "") "Canary") -}}

{{- /* Build backendRefs based on deployment type */ -}}
{{- $backendRefs := list -}}
{{- if .Values.grpcRoute.backendRefs -}}
  {{- $backendRefs = .Values.grpcRoute.backendRefs -}}
{{- else if $isCanary -}}
  {{- /* For Canary: stable (100%) and canary (0%) services */ -}}
  {{- $stableRef := dict "name" $serviceName "port" $servicePort "weight" 100 -}}
  {{- $canaryRef := dict "name" (printf "%s-preview" $serviceName) "port" $servicePort "weight" 0 -}}
  {{- $backendRefs = list $stableRef $canaryRef -}}
{{- else -}}
  {{- /* For regular deployment: single backend */ -}}
  {{- $backendRefs = list (dict "name" $serviceName "port" $servicePort) -}}
{{- end -}}

---
apiVersion: gateway.networking.k8s.io/v1
kind: GRPCRoute
metadata:
  {{- include "shortlink-common.metadata" . | nindent 2 }}
spec:
  {{- if .Values.grpcRoute.parentRefs }}
  parentRefs:
    {{- toYaml .Values.grpcRoute.parentRefs | nindent 4 }}
  {{- else }}
  parentRefs:
    - name: {{ .Values.grpcRoute.gatewayName | default "internal-gateway" }}
      namespace: {{ .Values.grpcRoute.gatewayNamespace | default "istio-system" }}
  {{- end }}

  {{- with .Values.grpcRoute.hostnames }}
  hostnames:
    {{- range . }}
    - {{ . | quote }}
    {{- end }}
  {{- end }}

  {{- if .Values.grpcRoute.rules }}
  rules:
    {{- toYaml .Values.grpcRoute.rules | nindent 4 }}
  {{- else }}
  rules:
    - matches:
        {{- if .Values.grpcRoute.methods }}
        {{- range .Values.grpcRoute.methods }}
        - method:
            type: Exact
            service: {{ . | quote }}
        {{- end }}
        {{- else if .Values.grpcRoute.method }}
        - method:
            type: Exact
            service: {{ .Values.grpcRoute.method | quote }}
        {{- end }}
      backendRefs:
        {{- toYaml $backendRefs | nindent 8 }}
  {{- end }}
{{- end }}
{{- end }}
