{{/* vim: set filetype=mustache: */}}

{{/*
`shortlink-common.http_route` Helm template

Behavior:
- Generates an HTTPRoute when `httpRoute.enabled` is true.
- By default attaches to Gateway:
    name: external-gateway
    namespace: istio-system
- By default routes "/" to the first `service.ports[]` entry with `public: true`.
- Backend service name defaults to `helpers.fullname`.

Override points in values:
- httpRoute.hostnames
- httpRoute.gatewayName / httpRoute.gatewayNamespace
- httpRoute.parentRefs (full override)
- httpRoute.path
- httpRoute.port
- httpRoute.rules (full override of rules block)
*/}}

{{- define "shortlink-common.http_route" }}
{{- if .Values.httpRoute.enabled }}
{{- $ := . }}

{{/* Compute default backend port: first public service port */}}
{{- $backend := dict }}
{{- range .Values.service.ports }}
  {{- if and .public (not (hasKey $backend "port")) }}
    {{- $_ := set $backend "port" .port }}
  {{- end }}
{{- end }}
{{- $defaultBackendPort := (index $backend "port" | default 80) }}

---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  {{- include "shortlink-common.metadata" . | nindent 2 }}
spec:
  {{- if .Values.httpRoute.parentRefs }}
  parentRefs:
    {{- toYaml .Values.httpRoute.parentRefs | nindent 4 }}
  {{- else }}
  parentRefs:
    - name: {{ .Values.httpRoute.gatewayName | default "external-gateway" }}
      namespace: {{ .Values.httpRoute.gatewayNamespace | default "istio-system" }}
  {{- end }}

  {{- with .Values.httpRoute.hostnames }}
  hostnames:
    {{- range . }}
    - {{ . | quote }}
    {{- end }}
  {{- end }}

  {{- if .Values.httpRoute.rules }}
  rules:
    {{- toYaml .Values.httpRoute.rules | nindent 4 }}
  {{- else }}
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: {{ .Values.httpRoute.path | default "/" | quote }}
      backendRefs:
        - name: {{ include "helpers.fullname" . }}
          port: {{ .Values.httpRoute.port | default $defaultBackendPort }}
  {{- end }}
{{- end }}
{{- end }}
